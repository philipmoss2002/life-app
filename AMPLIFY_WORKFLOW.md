# Amplify DataStore Workflow

This document explains the workflow for setting up Amplify DataStore and when files get generated.

## Current State ‚úÖ

Your project is currently in **Phase 1** - ready for Amplify CLI setup.

- ‚úÖ Dependencies installed (`amplify_datastore`, etc.)
- ‚úÖ `AmplifyService` created (with placeholder for models)
- ‚úÖ GraphQL schema ready (`schema.graphql`)
- ‚úÖ Documentation complete
- ‚è≥ Amplify CLI not yet run
- ‚è≥ Models not yet generated
- ‚è≥ AWS resources not yet created

## The Workflow

### Phase 1: Initial Setup (CURRENT) ‚úÖ

**What you have:**
- Flutter dependencies installed
- `AmplifyService` with TODO comments
- GraphQL schema file
- Configuration structure

**What's missing:**
- `lib/models/ModelProvider.dart` - Generated by Amplify CLI
- `lib/amplifyconfiguration.dart` - Generated by Amplify CLI
- AWS resources (Cognito, AppSync, DynamoDB, S3)

**Why it's missing:**
These files are **generated automatically** by the Amplify CLI when you run `amplify push`. You don't create them manually!

### Phase 2: Run Amplify CLI ‚è≥

**Commands to run:**

```bash
# 1. Install Amplify CLI (if not already installed)
npm install -g @aws-amplify/cli

# 2. Configure Amplify with your AWS credentials
amplify configure

# 3. Initialize Amplify in your project
cd household_docs_app
amplify init

# 4. Add authentication
amplify add auth

# 5. Add API with DataStore
amplify add api
# When prompted:
# - Service: GraphQL
# - API name: householdDocsAPI
# - Authorization: Amazon Cognito User Pool
# - Schema: Use the schema.graphql file

# 6. Add storage for files
amplify add storage

# 7. Push to AWS (creates resources and generates code)
amplify push
```

**What `amplify push` does:**
1. Creates AWS resources (Cognito, AppSync, DynamoDB, S3)
2. Generates `lib/models/` directory with:
   - `ModelProvider.dart`
   - `Document.dart`
   - `FileAttachment.dart`
   - `Device.dart`
   - etc.
3. Generates `lib/amplifyconfiguration.dart`
4. Sets up sync infrastructure

### Phase 3: Update Code After Generation ‚è≥

**After `amplify push` completes, update these files:**

#### 1. Update `lib/services/amplify_service.dart`

**Before (current):**
```dart
// TODO: Uncomment these imports after running 'amplify push'
// import '../models/ModelProvider.dart';
// import '../amplifyconfiguration.dart';

// In _addPlugins():
await Amplify.addPlugin(
  AmplifyDataStore(modelProvider: null),
);

// In initialize():
final amplifyConfig = config.AmplifyEnvironmentConfig.getConfig();
final configJson = jsonEncode(amplifyConfig);
await Amplify.configure(configJson);
```

**After (once models are generated):**
```dart
import '../models/ModelProvider.dart';
import '../amplifyconfiguration.dart';

// In _addPlugins():
await Amplify.addPlugin(
  AmplifyDataStore(modelProvider: ModelProvider.instance),
);

// In initialize():
await Amplify.configure(amplifyconfig);
```

#### 2. Update `lib/main.dart`

Uncomment the Amplify initialization:

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize timezone data
  tz.initializeTimeZones();

  // Initialize database
  await DatabaseService.instance.database;

  // Initialize notifications
  await NotificationService.instance.initialize();

  // Initialize Amplify for cloud sync
  try {
    await AmplifyService().initialize();
    debugPrint('Amplify initialized successfully');
  } catch (e) {
    debugPrint('Failed to initialize Amplify: $e');
    // App can still work in local-only mode
  }

  runApp(const HouseholdDocsApp());
}
```

### Phase 4: Use DataStore in Your App ‚è≥

Replace local database calls with DataStore:

**Before (local SQLite):**
```dart
await DatabaseService.instance.insertDocument(document);
final docs = await DatabaseService.instance.getAllDocuments();
```

**After (DataStore - syncs automatically):**
```dart
import 'package:amplify_flutter/amplify_flutter.dart';
import '../models/Document.dart';

// Create
final doc = Document(
  title: 'Car Insurance',
  category: 'Insurance',
  version: 1,
  deleted: false,
);
await Amplify.DataStore.save(doc);

// Query
final docs = await Amplify.DataStore.query(
  Document.classType,
  where: Document.DELETED.eq(false),
);

// Observe changes
Amplify.DataStore.observe(Document.classType).listen((event) {
  print('Document ${event.eventType}: ${event.item.title}');
});
```

## File Generation Timeline

### Files That Exist Now ‚úÖ
- `lib/services/amplify_service.dart` (with TODOs)
- `lib/config/amplify_config.dart`
- `schema.graphql`
- All documentation files

### Files Generated by `amplify push` ‚è≥
- `lib/models/ModelProvider.dart`
- `lib/models/Document.dart`
- `lib/models/FileAttachment.dart`
- `lib/models/Device.dart`
- `lib/models/SyncQueue.dart`
- `lib/models/Subscription.dart`
- `lib/models/StorageUsage.dart`
- `lib/models/Conflict.dart`
- `lib/amplifyconfiguration.dart`
- `amplify/` directory (backend configuration)

### Files Generated by Amplify CLI ‚è≥
- `amplify/backend/api/householdDocsAPI/` (GraphQL API config)
- `amplify/backend/auth/` (Cognito config)
- `amplify/backend/storage/` (S3 config)
- `amplify/#current-cloud-backend/` (deployed resources)

## Why This Approach?

**Q: Why not create ModelProvider.dart manually?**

A: Because it's auto-generated from your GraphQL schema. The Amplify CLI:
- Parses your schema
- Generates type-safe Dart classes
- Creates relationships between models
- Adds serialization/deserialization
- Includes DataStore-specific code
- Keeps everything in sync

Manual creation would be error-prone and hard to maintain.

**Q: Can I run the app before `amplify push`?**

A: Yes! The app will run, but:
- Amplify won't be initialized (that's okay)
- Cloud sync won't work (expected)
- Local database still works (as before)
- No errors, just logs saying Amplify isn't configured

**Q: What if I change the schema later?**

A: Just run `amplify push` again. It will:
- Update the GraphQL API
- Regenerate the models
- Migrate DynamoDB tables
- Keep your data safe

## Troubleshooting

### Error: "ModelProvider doesn't exist"

**Cause:** You haven't run `amplify push` yet.

**Solution:** 
1. Run `amplify push` to generate models
2. Or comment out the Amplify initialization in `main.dart` until ready

### Error: "amplifyconfig doesn't exist"

**Cause:** You haven't run `amplify push` yet.

**Solution:** Same as above - run `amplify push`

### Error: "Amplify is not configured"

**Cause:** Amplify initialization failed or wasn't called.

**Solution:**
1. Check that `AmplifyService().initialize()` is called in `main.dart`
2. Check console logs for specific error
3. Verify AWS resources were created with `amplify status`

## Quick Reference

### Check Amplify Status
```bash
amplify status
```

### View Current Environment
```bash
amplify env list
```

### Pull Latest Backend Config
```bash
amplify pull
```

### Delete All Resources
```bash
amplify delete
```

### Switch Environment
```bash
amplify env checkout dev
amplify env checkout prod
```

## Next Steps

1. ‚úÖ You're here - understanding the workflow
2. ‚è≥ Install Amplify CLI: `npm install -g @aws-amplify/cli`
3. ‚è≥ Run `amplify configure` to set up AWS credentials
4. ‚è≥ Run `amplify init` in your project
5. ‚è≥ Add services: `amplify add auth`, `amplify add api`, `amplify add storage`
6. ‚è≥ Run `amplify push` to create resources and generate code
7. ‚è≥ Update `AmplifyService` with generated imports
8. ‚è≥ Uncomment Amplify initialization in `main.dart`
9. ‚è≥ Replace database calls with DataStore operations
10. ‚è≥ Test offline sync functionality

## Summary

**Current State:**
- ‚úÖ Project structure ready
- ‚úÖ Dependencies installed
- ‚úÖ Schema defined
- ‚è≥ Waiting for `amplify push` to generate models

**What to do:**
1. Run Amplify CLI commands
2. Wait for code generation
3. Update imports in `AmplifyService`
4. Start using DataStore!

The `ModelProvider.dart` file **will be created automatically** when you run `amplify push`. Don't try to create it manually! üöÄ
