# GraphQL Schema for Household Docs App
# This file should be placed in: amplify/backend/api/householdDocsAPI/schema.graphql
# After running: amplify add api

# Document model - represents a household document
type Document @model @auth(rules: [{allow: owner}]) {
  id: ID!
  title: String!
  category: String!
  renewalDate: AWSDateTime
  notes: String
  createdAt: AWSDateTime!
  lastModified: AWSDateTime!
  version: Int!
  deleted: Boolean!
  
  # Relationship: One document has many file attachments
  fileAttachments: [FileAttachment] @hasMany(indexName: "byDocument", fields: ["id"])
}

# FileAttachment model - represents files attached to documents
type FileAttachment @model @auth(rules: [{allow: owner}]) {
  id: ID!
  documentId: ID! @index(name: "byDocument", sortKeyFields: ["createdAt"])
  fileName: String!
  label: String
  fileSize: Int!
  s3Key: String!
  localPath: String
  createdAt: AWSDateTime!
  
  # Relationship: Each file attachment belongs to one document
  document: Document @belongsTo(fields: ["documentId"])
}

# Device model - tracks devices connected to user account
type Device @model @auth(rules: [{allow: owner}]) {
  id: ID!
  deviceName: String!
  deviceType: String!
  lastSyncTime: AWSDateTime!
  isActive: Boolean!
  createdAt: AWSDateTime!
}

# SyncQueue model - tracks pending sync operations (optional)
type SyncQueue @model @auth(rules: [{allow: owner}]) {
  id: ID!
  operation: String!
  entityType: String!
  entityId: String!
  timestamp: AWSDateTime!
  expiresAt: AWSDateTime @ttl
}

# Subscription model - tracks user subscription status
type Subscription @model @auth(rules: [{allow: owner}]) {
  id: ID!
  userId: String!
  planId: String!
  status: SubscriptionStatus!
  startDate: AWSDateTime!
  endDate: AWSDateTime
  autoRenew: Boolean!
  storageQuotaGB: Int!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

# Enum for subscription status
enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  GRACE_PERIOD
  TRIAL
}

# StorageUsage model - tracks user's storage usage
type StorageUsage @model @auth(rules: [{allow: owner}]) {
  id: ID!
  userId: String!
  usedBytes: Int!
  quotaBytes: Int!
  documentCount: Int!
  fileCount: Int!
  lastCalculated: AWSDateTime!
}

# Conflict model - tracks sync conflicts (optional, for manual resolution)
type Conflict @model @auth(rules: [{allow: owner}]) {
  id: ID!
  entityType: String!
  entityId: String!
  localVersion: AWSJSON!
  remoteVersion: AWSJSON!
  detectedAt: AWSDateTime!
  resolvedAt: AWSDateTime
  resolution: ConflictResolution
}

# Enum for conflict resolution strategy
enum ConflictResolution {
  KEEP_LOCAL
  KEEP_REMOTE
  MERGE
  MANUAL
}

# Schema Directives Explained:
# 
# @model
# - Creates DynamoDB table
# - Generates CRUD operations (create, read, update, delete)
# - Enables DataStore sync
#
# @auth(rules: [{allow: owner}])
# - Row-level security
# - Users can only access their own data
# - Owner field automatically added (uses Cognito user ID)
#
# @hasMany / @belongsTo
# - Defines one-to-many relationships
# - Automatically creates foreign keys
# - Enables nested queries
#
# @index
# - Creates DynamoDB secondary index
# - Enables efficient queries
# - sortKeyFields defines sort order
#
# @ttl
# - Automatic deletion after expiration
# - Useful for temporary data (sync queue)
# - DynamoDB handles cleanup

# Example Queries (Generated Automatically):
#
# Create Document:
# mutation CreateDocument {
#   createDocument(input: {
#     title: "Car Insurance"
#     category: "Insurance"
#     renewalDate: "2024-12-31T00:00:00Z"
#     version: 1
#     deleted: false
#   }) {
#     id
#     title
#     createdAt
#   }
# }
#
# List Documents:
# query ListDocuments {
#   listDocuments(filter: {deleted: {eq: false}}) {
#     items {
#       id
#       title
#       category
#       renewalDate
#       fileAttachments {
#         items {
#           fileName
#           s3Key
#         }
#       }
#     }
#   }
# }
#
# Get Document with Files:
# query GetDocument {
#   getDocument(id: "document-id") {
#     id
#     title
#     category
#     fileAttachments {
#       items {
#         id
#         fileName
#         fileSize
#         s3Key
#       }
#     }
#   }
# }
#
# Subscribe to Document Changes:
# subscription OnCreateDocument {
#   onCreateDocument {
#     id
#     title
#     category
#   }
# }

# Notes:
# 1. All timestamps use AWSDateTime (ISO 8601 format)
# 2. AWSJSON type stores arbitrary JSON data
# 3. Owner field is automatically added by @auth directive
# 4. Cognito user ID is used as owner value
# 5. DataStore handles all sync automatically
# 6. Conflicts resolved with last-writer-wins by default
# 7. Can customize conflict resolution in Flutter code
